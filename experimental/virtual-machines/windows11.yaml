# Notes
# 1. copy installer isos to GCS bucket
# 2. Create an empty VM Disk
#
apiVersion: vm.cluster.gke.io/v1
kind: VirtualMachine
metadata:
  name: windows11
  namespace: vms
spec:
  osType: Windows
  firmware:
    bootloader:
      type: uefi
      enableSecureBoot: true
  # tpm: {}
  disks:
    - boot: true
      virtualMachineDiskName: windows11-boot
      driver: virtio
    - virtualMachineDiskName: windows11-iso
    - virtualMachineDiskName: virtio-driver
  compute:
    cpu:
      vcpus: 4
    memory:
      capacity: 8Gi
    machineChipSet: q35
  interfaces:
    - name: eth0
      networkName: pod-network
      default: true

---
apiVersion: vm.cluster.gke.io/v1
kind: VirtualMachineDisk
metadata:
  name: windows11-boot
  namespace: vms
spec:
  size: 30Gi
  storageClassName: robin-vm-repl-2-block-immediate


---
apiVersion: v1
kind: Service
metadata:
  name: remote-access-to-windows11
  namespace: vms
spec:
  type: LoadBalancer
  ports:
  - name: rdp-tcp
    port: 3389
    protocol: TCP
    targetPort: 3389
  - name: rdp-udp
    port: 3389
    protocol: UDP
    targetPort: 3389
  selector:
    kubevirt/vm: windows11

---
apiVersion: vm.cluster.gke.io/v1
kind: VirtualMachineDisk
metadata:
  name: virtio-driver
  namespace: vms
spec:
  size: 1Gi
  source:
    registry:
      url: docker://quay.io/kubevirt/virtio-container-disk:latest
  storageClassName: robin-vm-repl-2-block-immediate
  diskType: cdrom

---
apiVersion: vm.cluster.gke.io/v1
kind: VirtualMachineDisk
metadata:
  name: windows11-iso
  namespace: vms
spec:
  source:
    gcs:
      url: gs://living-on-the-edge-vm-images/isos/Win11_23H2_English_x64v2.iso
      secretRef: vm-image-importer
  size: 10Gi
  storageClassName: robin-vm-repl-2-block-immediate
  diskType: cdrom
